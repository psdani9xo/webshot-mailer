{% extends "base.html" %}
{% block content %}
<h3>Historial</h3>

<form class="row g-2 mb-3 align-items-end">
  <div class="col-auto">
    <select name="task_id" class="form-select">
      <option value="">Todas</option>
      {% for t in tasks %}
        <option value="{{t.id}}" {% if task_id==t.id %}selected{% endif %}>{{t.name}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <select name="status" class="form-select">
      <option value="">OK y ERROR</option>
      <option value="OK" {% if status=='OK' %}selected{% endif %}>Solo OK</option>
      <option value="ERROR" {% if status=='ERROR' %}selected{% endif %}>Solo ERROR</option>
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label">Desde</label>
    <input type="date" name="from_date" value="{{from_date}}" class="form-control" />
  </div>
  <div class="col-auto">
    <label class="form-label">Hasta</label>
    <input type="date" name="to_date" value="{{to_date}}" class="form-control" />
  </div>
  <div class="col-auto">
    <button class="btn btn-primary" type="submit">Filtrar</button>
  </div>
</form>

<div class="mb-2 text-muted">
  Mostrando {{shown}} de {{total_runs}} ejecuciones (max 200 mas recientes).
  {% if status %}
    Filtro de estado: <strong>{{status}}</strong>.
  {% endif %}
  {% if from_date or to_date %}
    Rango: <strong>{{from_date or 'inicio'}}</strong> a <strong>{{to_date or 'ahora'}}</strong>.
  {% endif %}
</div>

<table class="table table-striped bg-white">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Tarea</th>
      <th>Trigger</th>
      <th>Status</th>
      <th>Duracion</th>
      <th>Captura</th>
      <th>Error</th>
    </tr>
  </thead>
  <tbody>
  {% for r in runs %}
    <tr>
      <td>{{r.started_at}}</td>
      <td>{{r.task.name}}</td>
      <td>{{r.trigger}}</td>
      <td>
        {% if r.status=="OK" %}<span class="badge bg-success">OK</span>{% else %}<span class="badge bg-danger">ERROR</span>{% endif %}
      </td>
      <td>{{r.duration_ms}} ms</td>
      <td>
        {% if r.screenshot_path %}
          {% set fname = r.screenshot_path.split('/')[-1] %}
          <a href="/captures/{{fname}}" target="_blank">ver</a>
        {% else %}-{% endif %}
      </td>
      <td style="max-width:400px;">{{r.error_message}}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
