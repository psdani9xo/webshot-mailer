{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Tareas</h3>
  <a class="btn btn-primary" href="/tasks/new">Nueva tarea</a>
</div>

<table class="table table-striped bg-white">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Estado</th>
      <th>Schedule</th>
      <th>URL</th>
      <th>Ultimo</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  {% for t in tasks %}
    {% set r = latest.get(t.id) %}
    <tr>
      <td>{{t.name}}</td>
      <td>
        {% if t.enabled %}<span class="badge bg-success">ON</span>{% else %}<span class="badge bg-secondary">OFF</span>{% endif %}
      </td>
      <td>{{t.schedule_type}} {% if t.time_hhmm %}{{t.time_hhmm}}{% endif %} {% if t.weekdays %}({{t.weekdays}}){% endif %} {% if t.interval_minutes %}{{t.interval_minutes}}m{% endif %}</td>
      <td style="max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{t.url}}</td>
      <td>
        {% if r %}
          {% if r.status == "OK" %}<span class="badge bg-success">OK</span>{% else %}<span class="badge bg-danger">ERROR</span>{% endif %}
          <div class="small text-muted">{{r.started_at}}</div>
        {% else %}
          -
        {% endif %}
      </td>
      <td class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-primary" href="/tasks/{{t.id}}/edit">Editar</a>
        <form method="post" action="/tasks/{{t.id}}/toggle">
          <button class="btn btn-sm btn-outline-secondary" type="submit">{{ "Pausar" if t.enabled else "Activar" }}</button>
        </form>
        <form method="post" action="/tasks/{{t.id}}/capture">
          <button class="btn btn-sm btn-outline-info" type="submit">Capturar</button>
        </form>
        <form method="post" action="/tasks/{{t.id}}/run">
          <button class="btn btn-sm btn-outline-success" type="submit">Test</button>
        </form>
        <a class="btn btn-sm btn-outline-dark" href="/runs?task_id={{t.id}}">Historial</a>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
