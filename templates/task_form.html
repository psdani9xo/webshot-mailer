{% extends "base.html" %}
{% block content %}
<h3>{{ "Nueva tarea" if not task else "Editar tarea" }}</h3>

<form method="post">
  <div class="row g-3">

    <div class="col-md-6">
      <label class="form-label">Nombre</label>
      <input class="form-control" name="name" value="{{task.name if task else ''}}" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Timezone</label>
      <input class="form-control" name="timezone" value="{{task.timezone if task else 'Europe/Madrid'}}">
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="enabled" {% if not task or task.enabled %}checked{% endif %}>
        <label class="form-check-label">Enabled</label>
      </div>
    </div>

    <hr class="mt-4">

    <h5>Programacion</h5>
    <div class="col-md-3">
      <label class="form-label">Tipo</label>
      {% set st = (task.schedule_type if task else 'DAILY') %}
      <select class="form-select" name="schedule_type">
        <option value="DAILY" {% if st=='DAILY' %}selected{% endif %}>DAILY</option>
        <option value="WEEKLY" {% if st=='WEEKLY' %}selected{% endif %}>WEEKLY</option>
        <option value="INTERVAL" {% if st=='INTERVAL' %}selected{% endif %}>INTERVAL</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Hora (HH:MM)</label>
      <input class="form-control" name="time_hhmm" value="{{task.time_hhmm if task and task.time_hhmm else '08:00'}}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Weekdays (1..7)</label>
      <input class="form-control" name="weekdays" value="{{task.weekdays if task and task.weekdays else '1,2,3,4,5'}}">
      <div class="form-text">Lun=1 ... Dom=7</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">Interval (min)</label>
      <input class="form-control" name="interval_minutes" value="{{task.interval_minutes if task and task.interval_minutes else ''}}">
    </div>

    <hr class="mt-4">

    <h5>Captura</h5>
    <div class="col-12">
      <label class="form-label">URL</label>
      <input class="form-control" name="url" value="{{task.url if task else ''}}" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">Viewport width</label>
      <input class="form-control" name="viewport_width" value="{{task.viewport_width if task else 1920}}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Viewport height</label>
      <input class="form-control" name="viewport_height" value="{{task.viewport_height if task else 5000}}">
    </div>
    <div class="col-md-3">
      <label class="form-label">CSS zoom</label>
      <input class="form-control" name="css_zoom" value="{{task.css_zoom if task else 1.0}}">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="full_page" {% if task and task.full_page %}checked{% endif %}>
        <label class="form-check-label">Full page (v1: viewport grande)</label>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Wait mode</label>
      {% set wm = (task.wait_mode if task else 'SLEEP') %}
      <select class="form-select" name="wait_mode">
        <option value="SLEEP" {% if wm=='SLEEP' %}selected{% endif %}>SLEEP</option>
        <option value="SELECTOR" {% if wm=='SELECTOR' %}selected{% endif %}>SELECTOR</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Wait seconds</label>
      <input class="form-control" name="wait_seconds" value="{{task.wait_seconds if task else 5}}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Wait selector (si SELECTOR)</label>
      <input class="form-control" name="wait_selector" value="{{task.wait_selector if task and task.wait_selector else ''}}">
    </div>

    <div class="col-md-6">
      <label class="form-label">Remove selectors (JSON)</label>
      <input class="form-control" name="remove_selectors" value="{{task.remove_selectors if task else '[]'}}">
      <div class="form-text">Ej: ["#WolfTelegram",".cookie"]</div>
    </div>
    <div class="col-md-6">
      <label class="form-label">pre_js (opcional)</label>
      <input class="form-control" name="pre_js" value="{{task.pre_js if task and task.pre_js else ''}}">
    </div>

    <hr class="mt-4">

    <h5>Email</h5>
    <div class="col-md-6">
      <label class="form-label">SMTP perfil</label>
      <select class="form-select" name="smtp_profile_id" required>
        {% for p in profiles %}
          <option value="{{p.id}}" {% if task and task.smtp_profile_id==p.id %}selected{% endif %}>{{p.name}}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">To (csv)</label>
      <input class="form-control" name="to_emails" value="{{task.to_emails if task else ''}}" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Cc (csv)</label>
      <input class="form-control" name="cc_emails" value="{{task.cc_emails if task and task.cc_emails else ''}}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Bcc (csv)</label>
      <input class="form-control" name="bcc_emails" value="{{task.bcc_emails if task and task.bcc_emails else ''}}">
    </div>

    <div class="col-12">
      <label class="form-label">Subject template</label>
      <input class="form-control" name="subject_template" value="{{task.subject_template if task else 'Captura {task_name} {date} {time}'}}">
    </div>

    <div class="col-12">
      <label class="form-label">HTML template</label>
      <textarea class="form-control" name="html_template" rows="6">{{task.html_template if task else ''}}</textarea>
      <div class="form-text">Para inline usa: &lt;img src="cid:screenshot"&gt;</div>
    </div>

    <div class="col-12">
      <label class="form-label">Text template (opcional)</label>
      <textarea class="form-control" name="text_template" rows="2">{{task.text_template if task and task.text_template else ''}}</textarea>
    </div>

    <div class="col-md-3">
      <label class="form-label">Retention days</label>
      <input class="form-control" name="retention_days" value="{{task.retention_days if task else 14}}">
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="attach_inline" {% if not task or task.attach_inline %}checked{% endif %}>
        <label class="form-check-label">Inline CID</label>
      </div>
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="attach_file" {% if task and task.attach_file %}checked{% endif %}>
        <label class="form-check-label">Adjuntar tambien</label>
      </div>
    </div>

  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-primary" type="submit">Guardar</button>
    <a class="btn btn-secondary" href="/">Volver</a>
  </div>
</form>
{% endblock %}
